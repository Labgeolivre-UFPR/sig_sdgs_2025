<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Trabalho Final de SIG</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

  <style>
    html, body {
      height: 100%;
      margin: 0;
    }
    #map {
      height: 100%;
      width: 100%;
    }
    .box {
      position: absolute;
      background: rgba(255, 255, 255, 0.6);
      padding: 8px 10px;
      margin-bottom: 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);

      font-family: "Arial", "sans-serif";
      font-size: 14px;
      pointer-events: auto;
      line-height: 28px;
      z-index: 2000;
    }
    #lineLayers {
      top: 10px;
      right: 10px;
    }
    #polyLayers {
      top: 250px;
      right: 10px;
      margin-top: 70px;
    }
    #legend {
      bottom: 30px;
      left: 10px;
      display: none;
    }
    .legend-item {
      width: 30px;
      height: 10px;
      display: inline-block;
    }
    #creatorBox {
      position: absolute;
      bottom: 10px;
      left: 10px;
      margin-left: 10px;
      z-index: 2000;
      font-family: "Arial", "sans-serif";
      font-size: 12px
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="creatorBox"><i>Feito por Christopher Pinheiro Dobb e João Victor Correia Stoski</i></div>
  <div class="box" id="lineLayers">
    <b>Camadas de linhas</b><br>
    <label><input type="radio" name="lineLayer" value="none" checked> Desabilitado</label><br>
    <label><input type="radio" name="lineLayer" value="bus_size"> Capacidade do ônibus</label><br>
    <label><input type="radio" name="lineLayer" value="tourism"> Linha de turismo</label><br>
    <i>Período de passagem (dia útil)</i><br>
    <label><input type="radio" name="lineLayer" value="freq_day"> Geral</label><br>
    <label><input type="radio" name="lineLayer" value="freq_peak1"> Primeiro pico (5:00 - 8:30)</label><br>
    <label><input type="radio" name="lineLayer" value="freq_off1"> Tarde (8:30 - 17:30)</label><br>
    <label><input type="radio" name="lineLayer" value="freq_peak2"> Segundo pico (17:30 - 19:00)</label><br>
    <label><input type="radio" name="lineLayer" value="freq_off2"> Noite (19:00 - 5:00)</label><br>
  </div>
  <div class="box" id="polyLayers">
    <b>Camadas de fundo</b><br>
    <label><input type="radio" name="polyLayer" value="none" checked> Desabilitado</label><br>
    <label><input type="radio" name="polyLayer" value="stop_density"> Densidade de pontos por bairro</label><br>
    <label><input type="radio" name="polyLayer" value="coverage"> Cobertura dos terminais</label><br>
    <label><input type="radio" name="polyLayer" value="coverage_pop"> População das coberturas</label><br>
  </div>
  <div class="box" id="legend">
    <div id="lineLegend"></div>
    <div id="polyLegend"></div>
  </div >
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    function addLegend(title, category, table) {
      var html_string = [`<b>${title}:</b><br>`];
      for (const [colour, value] of Object.entries(table)) {
        html_string.push(`<div class="legend-item" style="background-color:${colour};"></div> ${value}<br>`);
      }
      document.getElementById("legend").style.display = "block";
      document.getElementById(category + "Legend").innerHTML = html_string.join('\n');
    }

    const lineTranslator = {
      bus_size: "capacidade",
      freq_day: "periodo_geral",
      freq_peak1: "periodo_pico1",
      freq_off1: "periodo_fora1",
      freq_peak2: "periodo_pico2",
      freq_off2: "periodo_fora2",
    };
    const freqTable = {
      "#5A0F0F": "60 +",
      "#7A1E0F": "45 - 60",
      "#9A3A0F": "30 - 45",
      "#B58A0F": "15 - 30",
      "#6F7F0F": "10 - 15",
      "#3F6F0F": "5 - 10",
      "#0F5A0F": "0 - 5",
    };

    let activeLineLayer = null;
    let activeExtras = [];
    function switchLineLayer(layerTag) {
      if (activeLineLayer) {
        while (activeExtras.length) {
          map.removeLayer(activeExtras.pop());
        }
        map.removeLayer(activeLineLayer);
        activeLineLayer = null;
      }
      if (layerTag !== "none" && busLinesData) {
        // Tourism layer with extra features
        if (layerTag === "tourism") {
          activeLineLayer = L.geoJSON(busLinesData, {
            filter: function(feature) {
              return feature.properties.categoria_servico === "JARDINEIRA";
            },
            style: {
              color: "#518e36",
              weight: 2
            },
            pane: "linesPane"
          }).addTo(map);
          activeExtras.push(L.geoJSON(parkData, {
            style: {
              fillColor: "#85b66f",
              color: "#3f5634",
              fillOpacity: 0.7,
              weight: 1,
            },
            pane: "extraPane",
            onEachFeature: function(feature, layer) {
              layer.bindPopup(`${feature.properties.TEXTO_MAPA}`);
            }
          }).addTo(map));
          activeExtras.push(L.geoJSON(tourismStopsData, {
            pointToLayer: function(feature, latlng) {
              return L.circleMarker(latlng, {
                radius: 5,
                fillColor: "#fff",
                color: "#3f5634",
                weight: 2,
                opacity: 1.0,
                fillOpacity: 1.0,
                pane: "extraPane"
              });
            },
            onEachFeature: function(feature, layer) {
              layer.bindPopup(`<b>Ponto de parada:</b><br>${feature.properties.nome_ponto}`);
            }
          }).addTo(map));
        }
        // Other line layers
        else {
          const field = lineTranslator[layerTag];
          activeLineLayer = L.geoJSON(busLinesData, {
              style: function(feature) {return {
                color: feature.properties[field],
                weight: 2
              }},
              pane: "linesPane",
              onEachFeature: function(feature, layer) {
                layer.bindPopup(`
                <b>Código:</b> ${feature.properties.cod}<br>
                <b>Nome:</b> ${feature.properties.nome_linha}<br>
                <b>Tipo:</b> ${feature.properties.categoria_servico}<br>
                <b>Valor:</b> ${feature.properties["num_" + field]}<br>
                `);
              }
          }).addTo(map);
        }
      }
      switch (layerTag) {
        case "bus_size":
          addLegend("Capacidade de passageiros", "line", {
          "#5A0F0F": "77",
          "#7A1E0F": "87",
          "#9A3A0F": "93",
          "#B58A0F": "117",
          "#6F7F0F": "134",
          "#0F5A0F": "230",
          });
          break;
        case "freq_day": addLegend("Período de passagem (min)", "line", freqTable); break;
        case "freq_peak1": addLegend("Período de passagem (min)", "line", freqTable); break;
        case "freq_off1": addLegend("Período de passagem (min)", "line", freqTable); break;
        case "freq_peak2": addLegend("Período de passagem (min)", "line", freqTable); break;
        case "freq_off2": addLegend("Período de passagem (min)", "line", freqTable); break;
        case "none": document.getElementById("lineLegend").innerHTML = ""; break;
        case "tourism": document.getElementById("lineLegend").innerHTML = ""; break;
      }
      if (!activeLineLayer && !activePolyLayer) {
        document.getElementById("legend").style.display = "none";
      }
    }
    
    let activePolyLayer = null;
    function switchPolyLayer(layerTag) {
      if (activePolyLayer) {
        map.removeLayer(activePolyLayer);
        activePolyLayer = null;
      }
      if (!coverageData) return;
      switch (layerTag) {
        case "stop_density":
          activePolyLayer = L.geoJSON(bairroData, {
              style: function(feature) {return {
                color: '#000',
                fillColor: feature.properties.densidade,
                weight: 1,
                fillOpacity: 0.7,
                opacity: 1.0
              }},
              pane: "polyPane",
              onEachFeature: function(feature, layer) {
                layer.bindPopup(`
                <b>Bairro:</b> ${feature.properties.NOME}<br>
                <b>Densidade de paradas:</b> ${feature.properties.Densidade_paradas}<br>
                `);
              }
          }).addTo(map);
          addLegend("Paradas por km²", "poly", {
            "#fafafa": "1 - 10.1",
            "#d1d1d1": "10.1 - 19.3",
            "#a8a8a8": "19.3 - 28.4",
            "#808080": "28.4 - 37.6",
            "#575757": "37.6 - 46.7",
            "#2e2e2e": "46.7 - 55.9",
            "#050505": "55.9 - 65",
          });
          break;
        case "coverage":
          activePolyLayer = L.geoJSON(coverageData, {
            style: function(feature) {return {
              fillColor: "#" + ((1 << 24) * Math.random() | 0).toString(16).padStart(6, "0"),
              color: "#000",
              weight: 1,
              fillOpacity: 0.2,
              opacity: 1.0
            }},
            pane: "polyPane",
            onEachFeature: function(feature, layer) {
              layer.bindPopup(`
              <b>Terminal:</b> ${feature.properties.nome}<br>
              <b>População:</b> ${feature.properties.pop}
              `);
            }
          }).addTo(map);
          document.getElementById("polyLegend").innerHTML = "";
          break;
        case "coverage_pop":
          activePolyLayer = L.geoJSON(coverageData, {
            style: function(feature) {return {
              fillColor: feature.properties.population,
              fillOpacity: 0.7,
              color: "#000",
              weight: 1,
              opacity: 1.0
            }},
            pane: "polyPane",
            onEachFeature: function(feature, layer) {
              layer.bindPopup(`
              <b>Terminal:</b> ${feature.properties.nome}<br>
              <b>População:</b> ${feature.properties.pop}
              `);
            }
          }).addTo(map);
          addLegend("População", "poly", {
            "#d1e6f2": "63 - 41248",
            "#a7cadf": "41248 - 82433",
            "#7eafcc": "82433 - 123619",
            "#5493b9": "123619 - 164804",
            "#2a78a6": "164804 - 205989",
          })
          break;
        case "none":
          document.getElementById("polyLegend").innerHTML = "";
          break;
      }
      if (!activeLineLayer && !activePolyLayer) {
        document.getElementById("legend").style.display = "none";
      }
    }
    
    // Load JSONs
    let busLinesData = null;
    fetch("geojson/bus_lines.geojson")
      .then(response => response.json())
      .then(data => {busLinesData = data;})
      .catch(error => console.error("Error loading \"bus_lines.geojson\":", error));
    let bairroData = null;
    fetch("geojson/bairros.geojson")
      .then(response => response.json())
      .then(data => {bairroData = data;})
    let coverageData = null;
    fetch("geojson/terminal_coverage.geojson")
      .then(response => response.json())
      .then(data => {coverageData = data;})
    let parkData = null;
    fetch("geojson/parks.geojson")
      .then(response => response.json())
      .then(data => {parkData = data;})
    let tourismStopsData = null;
    fetch("geojson/tourism_stops.geojson")
      .then(response => response.json())
      .then(data => {tourismStopsData = data;})

    const map = L.map('map', {
      center: [-25.488009147759662, -49.28049770288324],
      zoom: 11
    });
    map.createPane("linesPane");
    map.getPane("linesPane").style.zIndex = 500;
    map.createPane("polyPane");
    map.getPane("polyPane").style.zIndex = 450;
    map.createPane("extraPane");
    map.getPane("extraPane").style.zIndex = 550;

    // OSM background
    L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: ' Map tiles by Carto, under CC BY 3.0. Data by OpenStreetMap, under ODbL.'
    }).addTo(map);

    // Layer toggle
    document.querySelectorAll("input[name='lineLayer']").forEach(r => {
      r.addEventListener("change", e => switchLineLayer(e.target.value));
    });
    document.querySelectorAll("input[name='polyLayer']").forEach(r => {
      r.addEventListener("change", e => switchPolyLayer(e.target.value));
    });
  </script>
</body>
</html>
